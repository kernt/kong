---

- name: Add BinTray deb repository
  become: yes
  apt_repository:
    repo: "deb https://dl.bintray.com/mashape/kong-ubuntu-{{ ansible_distribution_release }}-{{ kong.version | regex_replace('(^[0-9]+\\.[0-9]+).*$', '\\1.x') }}
      {{ ansible_distribution_release }} main"
    state: present

  # We need to force the install due to lack of GPG signature.
- name: "Install Kong {{ kong.version }}"
  become: yes
  apt:
    name: "kong={{ kong.version }}"
    force: yes

- name: Ensure log directory owned by nginx user
  become: yes
  file:
    path: /usr/local/kong/logs
    state: directory
    owner: www-data
    group: www-data

- name: Create kong init.d script
  become: yes
  template:
    dest: /etc/init.d/kong
    mode: 0751
    src: initd.j2
  when: ansible_service_mgr == 'upstart'

- name: Create kong systemd script
  become: yes
  template:
    dest: /etc/systemd/system/kong.service
    mode: 0755
    src: systemd.j2
  when: ansible_service_mgr == 'systemd'

- name: Ensure kong service is enabled
  become: yes
  service:
    name: kong
    enabled: yes
    state: stopped
